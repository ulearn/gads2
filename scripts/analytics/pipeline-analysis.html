<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pipeline Analysis - Enhanced with Territory Validation</title>
    
    <!-- React & Dependencies -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Chart Library -->
    <script src="https://unpkg.com/recharts@2.8.0/umd/Recharts.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        }
        
        .pipeline-stage {
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }
        
        .pipeline-stage:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        
        .stage-inbox { border-left-color: #3b82f6; }
        .stage-sequenced { border-left-color: #10b981; }
        .stage-engaging { border-left-color: #f59e0b; }
        .stage-responsive { border-left-color: #ef4444; }
        .stage-advising { border-left-color: #8b5cf6; }
        .stage-negotiation { border-left-color: #06b6d4; }
        .stage-contract { border-left-color: #84cc16; }
        .stage-won { border-left-color: #22c55e; }
        .stage-lost { border-left-color: #dc2626; }
        
        .mql-validation-flow {
            background: linear-gradient(90deg, #dbeafe 0%, #fef3c7 50%, #dcfce7 100%);
        }
        
        .loading {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .burn-rate-alert {
            animation: pulse 2s infinite;
            background-color: #fee2e2;
            border-color: #ef4444;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
    </style>
</head>
<body>
    <div id="pipeline-root"></div>

    <script type="text/babel">
        const PipelineAnalysis = () => {
            const [pipelineData, setPipelineData] = React.useState(null);
            const [isLoading, setIsLoading] = React.useState(true);
            const [error, setError] = React.useState(null);
            const [analysisMode, setAnalysisMode] = React.useState('pipeline');
            const [dateRange, setDateRange] = React.useState('30');
            const [probabilities, setProbabilities] = React.useState(null);

            React.useEffect(() => {
                fetchPipelineData();
            }, [analysisMode, dateRange]);

            const fetchPipelineData = async () => {
                setIsLoading(true);
                setError(null);
                
                try {
                    console.log(`📊 Fetching pipeline data: ${dateRange} days, ${analysisMode} mode`);
                    
                    // Fetch enhanced pipeline data
                    const [dashboardRes, mqlValidationRes, territoriesRes] = await Promise.all([
                        fetch(`/gads/analytics/dashboard-data?days=${dateRange}&mode=${analysisMode}`),
                        fetch(`/gads/analytics/mql-validation?days=${dateRange}&mode=${analysisMode}`),
                        fetch(`/gads/analytics/territories?days=${dateRange}&mode=${analysisMode}`)
                    ]);

                    const [dashboardData, mqlValidationData, territoriesData] = await Promise.all([
                        dashboardRes.json(),
                        mqlValidationRes.json(),
                        territoriesRes.json()
                    ]);

                    if (!dashboardData.success) throw new Error(dashboardData.error);
                    if (!mqlValidationData.success) throw new Error(mqlValidationData.error);
                    if (!territoriesData.success) throw new Error(territoriesData.error);

                    setPipelineData({
                        dashboard: dashboardData,
                        mqlValidation: mqlValidationData,
                        territories: territoriesData
                    });

                } catch (err) {
                    console.error('❌ Pipeline data fetch failed:', err);
                    setError(err.message);
                }
                
                setIsLoading(false);
            };

            const refreshProbabilities = async () => {
                try {
                    console.log('🔄 Refreshing pipeline probabilities...');
                    const response = await fetch('/gads/scripts/analytics/pipeline-probs.js');
                    const result = await response.json();
                    setProbabilities(result);
                    alert('Pipeline probabilities refreshed successfully!');
                } catch (err) {
                    console.error('❌ Probability refresh failed:', err);
                    alert('Failed to refresh probabilities: ' + err.message);
                }
            };

            const formatNumber = (value) => {
                return new Intl.NumberFormat().format(value || 0);
            };

            const formatCurrency = (value) => {
                return new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'EUR',
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0,
                }).format(value || 0);
            };

            if (isLoading) {
                return React.createElement('div', {
                    className: 'min-h-screen bg-gradient-to-br from-slate-50 to-blue-50 flex items-center justify-center'
                }, [
                    React.createElement('div', {
                        className: 'text-center',
                        key: 'loading'
                    }, [
                        React.createElement('div', { className: 'loading mb-4', key: 'spinner' }),
                        React.createElement('p', {
                            className: 'text-lg text-gray-600',
                            key: 'loading-text'
                        }, 'Loading enhanced pipeline analysis...'),
                        React.createElement('p', {
                            className: 'text-sm text-gray-500 mt-2',
                            key: 'loading-subtitle'
                        }, `Mode: ${analysisMode}, Range: ${dateRange} days`)
                    ])
                ]);
            }

            if (error) {
                return React.createElement('div', {
                    className: 'min-h-screen bg-gradient-to-br from-slate-50 to-blue-50 flex items-center justify-center'
                }, [
                    React.createElement('div', {
                        className: 'text-center bg-white p-8 rounded-xl shadow-lg max-w-md',
                        key: 'error'
                    }, [
                        React.createElement('h2', {
                            className: 'text-xl font-bold text-red-600 mb-4',
                            key: 'error-title'
                        }, '❌ Pipeline Analysis Error'),
                        React.createElement('p', {
                            className: 'text-gray-600 mb-4',
                            key: 'error-message'
                        }, error),
                        React.createElement('button', {
                            className: 'bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600',
                            onClick: () => window.location.reload(),
                            key: 'reload-btn'
                        }, 'Reload Analysis')
                    ])
                ]);
            }

            if (!pipelineData) return null;

            const { dashboard, mqlValidation, territories } = pipelineData;
            const unsupportedTerritory = territories.territories.find(t => t.isUnsupported);

            return React.createElement('div', {
                className: 'min-h-screen bg-gradient-to-br from-slate-50 to-blue-50 p-6'
            }, [
                // Header with Enhanced Controls
                React.createElement('div', {
                    className: 'mb-8',
                    key: 'header'
                }, [
                    React.createElement('div', {
                        className: 'flex flex-col lg:flex-row lg:items-center lg:justify-between mb-6',
                        key: 'header-content'
                    }, [
                        React.createElement('div', { key: 'header-text' }, [
                            React.createElement('h1', {
                                className: 'text-3xl font-bold text-gray-900 mb-2',
                                key: 'title'
                            }, '📊 Enhanced Pipeline Analysis'),
                            React.createElement('p', {
                                className: 'text-gray-600',
                                key: 'subtitle'
                            }, `Complete Click→Contact→Deal→Revenue Pipeline (${dashboard.period})`)
                        ]),
                        
                        React.createElement('div', {
                            className: 'flex flex-col sm:flex-row gap-4',
                            key: 'controls'
                        }, [
                            React.createElement('select', {
                                value: analysisMode,
                                onChange: (e) => setAnalysisMode(e.target.value),
                                className: 'bg-white border border-gray-300 rounded-lg px-4 py-2',
                                key: 'mode-select'
                            }, [
                                React.createElement('option', { value: 'pipeline', key: 'pipeline' }, 'Pipeline Analysis'),
                                React.createElement('option', { value: 'revenue', key: 'revenue' }, 'Revenue Analysis')
                            ]),
                            
                            React.createElement('select', {
                                value: dateRange,
                                onChange: (e) => setDateRange(e.target.value),
                                className: 'bg-white border border-gray-300 rounded-lg px-4 py-2',
                                key: 'date-select'
                            }, [
                                React.createElement('option', { value: '7', key: '7' }, 'Last 7 days'),
                                React.createElement('option', { value: '14', key: '14' }, 'Last 14 days'),
                                React.createElement('option', { value: '30', key: '30' }, 'Last 30 days'),
                                React.createElement('option', { value: '60', key: '60' }, 'Last 60 days'),
                                React.createElement('option', { value: '90', key: '90' }, 'Last 90 days')
                            ]),
                            
                            React.createElement('button', {
                                onClick: refreshProbabilities,
                                className: 'bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors',
                                key: 'refresh-btn'
                            }, '🔄 Refresh Probabilities')
                        ])
                    ]),

                    // Analysis Mode Explanation
                    React.createElement('div', {
                        className: 'p-4 bg-blue-50 rounded-lg border border-blue-200',
                        key: 'mode-explanation'
                    }, [
                        React.createElement('div', {
                            className: 'flex items-start space-x-2',
                            key: 'explanation-content'
                        }, [
                            React.createElement('span', { className: 'text-blue-600', key: 'icon' }, 'ℹ️'),
                            React.createElement('div', {
                                className: 'text-sm text-blue-800',
                                key: 'explanation-text'
                            }, [
                                React.createElement('strong', { key: 'mode-title' }, 
                                    analysisMode === 'pipeline' ? 'Pipeline Analysis Mode' : 'Revenue Analysis Mode'
                                ),
                                React.createElement('span', { key: 'mode-desc' }, 
                                    analysisMode === 'pipeline' 
                                        ? ' - Filters by deal creation date (shows current pipeline state)'
                                        : ' - Filters by deal close date (shows completed revenue only)'
                                )
                            ])
                        ])
                    ])
                ]),

                // MQL→SQL Validation Flow (Issue #2 Fix)
                React.createElement('div', {
                    className: 'mb-8',
                    key: 'mql-validation-section'
                }, [
                    React.createElement('h2', {
                        className: 'text-2xl font-bold text-gray-900 mb-6',
                        key: 'mql-title'
                    }, '🎯 Google Ads → HubSpot Conversion Pipeline'),
                    
                    React.createElement('div', {
                        className: 'mql-validation-flow p-6 rounded-lg border border-gray-200 mb-6',
                        key: 'validation-flow'
                    }, [
                        React.createElement('div', {
                            className: 'grid grid-cols-1 md:grid-cols-5 gap-4 items-center',
                            key: 'flow-stages'
                        }, [
                            // Stage 1: MQLs from Google Ads
                            React.createElement('div', {
                                className: 'text-center p-4 bg-blue-100 rounded-lg border-2 border-blue-300',
                                key: 'mql-stage'
                            }, [
                                React.createElement('div', {
                                    className: 'text-3xl font-bold text-blue-700',
                                    key: 'mql-count'
                                }, formatNumber(mqlValidation.mql_stage.total_mqls)),
                                React.createElement('div', {
                                    className: 'text-sm font-semibold text-blue-800',
                                    key: 'mql-label'
                                }, 'Marketing Qualified Leads'),
                                React.createElement('div', {
                                    className: 'text-xs text-blue-600 mt-1',
                                    key: 'mql-source'
                                }, 'Google Ads Clicks → Contacts')
                            ]),

                            // Stage 2: Territory Validation
                            React.createElement('div', {
                                className: 'text-center p-4 bg-yellow-100 rounded-lg border-2 border-yellow-300',
                                key: 'validation-stage'
                            }, [
                                React.createElement('div', {
                                    className: 'text-2xl font-bold text-yellow-700',
                                    key: 'validation-passed'
                                }, formatNumber(mqlValidation.mql_stage.supported_mqls)),
                                React.createElement('div', {
                                    className: 'text-sm font-semibold text-yellow-800',
                                    key: 'validation-label'
                                }, 'Territory Validation'),
                                React.createElement('div', {
                                    className: 'text-xs text-red-600 mt-1',
                                    key: 'validation-burn'
                                }, `${mqlValidation.mql_stage.unsupported_mqls} unsupported`),
                                React.createElement('div', {
                                    className: 'text-xs text-red-600 font-bold',
                                    key: 'burn-rate'
                                }, `${mqlValidation.mql_stage.burn_rate_percentage}% burn rate`)
                            ]),

                            // Stage 3: SQLs (Deals Created)
                            React.createElement('div', {
                                className: 'text-center p-4 bg-green-100 rounded-lg border-2 border-green-300',
                                key: 'sql-stage'
                            }, [
                                React.createElement('div', {
                                    className: 'text-2xl font-bold text-green-700',
                                    key: 'sql-count'
                                }, formatNumber(mqlValidation.sql_validation.total_deals_created)),
                                React.createElement('div', {
                                    className: 'text-sm font-semibold text-green-800',
                                    key: 'sql-label'
                                }, 'Sales Qualified Leads'),
                                React.createElement('div', {
                                    className: 'text-xs text-green-600 mt-1',
                                    key: 'sql-rate'
                                }, `${mqlValidation.sql_validation.validation_rate_percentage}% validation rate`)
                            ]),

                            // Stage 4: Active Pipeline
                            React.createElement('div', {
                                className: 'text-center p-4 bg-purple-100 rounded-lg border-2 border-purple-300',
                                key: 'active-stage'
                            }, [
                                React.createElement('div', {
                                    className: 'text-2xl font-bold text-purple-700',
                                    key: 'active-count'
                                }, formatNumber(mqlValidation.sql_validation.active_deals)),
                                React.createElement('div', {
                                    className: 'text-sm font-semibold text-purple-800',
                                    key: 'active-label'
                                }, 'Active Pipeline'),
                                React.createElement('div', {
                                    className: 'text-xs text-purple-600 mt-1',
                                    key: 'active-desc'
                                }, 'In Progress')
                            ]),

                            // Stage 5: Won Deals
                            React.createElement('div', {
                                className: 'text-center p-4 bg-emerald-100 rounded-lg border-2 border-emerald-300',
                                key: 'won-stage'
                            }, [
                                React.createElement('div', {
                                    className: 'text-2xl font-bold text-emerald-700',
                                    key: 'won-count'
                                }, formatNumber(mqlValidation.sql_validation.won_deals)),
                                React.createElement('div', {
                                    className: 'text-sm font-semibold text-emerald-800',
                                    key: 'won-label'
                                }, 'Won Deals'),
                                React.createElement('div', {
                                    className: 'text-xs text-emerald-600 mt-1',
                                    key: 'won-desc'
                                }, 'Paying Customers')
                            ])
                        ])
                    ]),

                    // Burn Rate Alert (if significant)
                    mqlValidation.mql_stage.burn_rate_percentage > 10 && React.createElement('div', {
                        className: 'burn-rate-alert p-4 rounded-lg border-2 mb-6',
                        key: 'burn-alert'
                    }, [
                        React.createElement('div', {
                            className: 'flex items-center space-x-3',
                            key: 'alert-content'
                        }, [
                            React.createElement('span', {
                                className: 'text-2xl',
                                key: 'alert-icon'
                            }, '🔥'),
                            React.createElement('div', { key: 'alert-text' }, [
                                React.createElement('h3', {
                                    className: 'font-bold text-red-800',
                                    key: 'alert-title'
                                }, 'Burn Rate Alert'),
                                React.createElement('p', {
                                    className: 'text-red-700',
                                    key: 'alert-message'
                                }, `${mqlValidation.mql_stage.burn_rate_percentage}% of Google Ads traffic is from unsupported territories. ` +
                                   `${mqlValidation.mql_stage.unsupported_mqls} contacts generated no revenue potential.`),
                                React.createElement('button', {
                                    className: 'mt-2 bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700',
                                    onClick: () => window.open('/gads/scripts/analytics/burn-rate.html', '_blank'),
                                    key: 'burn-details-btn'
                                }, 'View Burn Rate Details →')
                            ])
                        ])
                    ])
                ]),

                // Pipeline Stages Overview
                React.createElement('div', {
                    className: 'grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8',
                    key: 'pipeline-overview'
                }, [
                    // Deal Pipeline Stages
                    React.createElement('div', {
                        className: 'bg-white rounded-lg shadow p-6',
                        key: 'deal-stages'
                    }, [
                        React.createElement('h3', {
                            className: 'text-lg font-semibold text-gray-900 mb-4',
                            key: 'stages-title'
                        }, '📋 Deal Pipeline Stages'),
                        
                        React.createElement('div', {
                            className: 'space-y-3',
                            key: 'stages-list'
                        }, [
                            // Map through pipeline stages (you'll need to extract this from your data)
                            dashboard.summary.pipeline_stages && Object.entries(dashboard.summary.pipeline_stages).map(([stageName, stageData], index) => 
                                React.createElement('div', {
                                    className: `pipeline-stage p-4 bg-gray-50 rounded-lg border stage-${stageName.toLowerCase().replace(/\s+/g, '-')}`,
                                    key: `stage-${index}`
                                }, [
                                    React.createElement('div', {
                                        className: 'flex justify-between items-center',
                                        key: 'stage-header'
                                    }, [
                                        React.createElement('h4', {
                                            className: 'font-medium text-gray-900',
                                            key: 'stage-name'
                                        }, stageName.toUpperCase()),
                                        React.createElement('span', {
                                            className: 'text-lg font-bold text-blue-600',
                                            key: 'stage-count'
                                        }, formatNumber(stageData.count))
                                    ]),
                                    React.createElement('div', {
                                        className: 'mt-2 text-sm text-gray-600',
                                        key: 'stage-details'
                                    }, [
                                        React.createElement('span', { key: 'value' }, `Value: ${formatCurrency(stageData.value)}`),
                                        stageData.avg_value > 0 && React.createElement('span', { 
                                            key: 'avg', 
                                            className: 'ml-4' 
                                        }, `Avg: ${formatCurrency(stageData.avg_value)}`)
                                    ])
                                ])
                            )
                        ])
                    ]),

                    // Territory Performance Summary
                    React.createElement('div', {
                        className: 'bg-white rounded-lg shadow p-6',
                        key: 'territory-summary'
                    }, [
                        React.createElement('h3', {
                            className: 'text-lg font-semibold text-gray-900 mb-4',
                            key: 'territory-title'
                        }, '🌍 Territory Performance Summary'),
                        
                        React.createElement('div', {
                            className: 'space-y-4',
                            key: 'territory-metrics'
                        }, [
                            // Total territories
                            React.createElement('div', {
                                className: 'flex justify-between items-center p-3 bg-blue-50 rounded',
                                key: 'total-territories'
                            }, [
                                React.createElement('span', { key: 'label' }, 'Active Territories'),
                                React.createElement('span', { 
                                    key: 'count',
                                    className: 'font-bold text-blue-600'
                                }, territories.territories.length)
                            ]),
                            
                            // Supported vs Unsupported
                            React.createElement('div', {
                                className: 'flex justify-between items-center p-3 bg-green-50 rounded',
                                key: 'supported-territories'
                            }, [
                                React.createElement('span', { key: 'label' }, 'Supported Territories'),
                                React.createElement('span', { 
                                    key: 'count',
                                    className: 'font-bold text-green-600'
                                }, territories.territories.filter(t => !t.isUnsupported).length)
                            ]),
                            
                            unsupportedTerritory && React.createElement('div', {
                                className: 'flex justify-between items-center p-3 bg-red-50 rounded cursor-pointer hover:bg-red-100',
                                onClick: () => window.open('/gads/scripts/analytics/burn-rate.html', '_blank'),
                                key: 'unsupported-territory'
                            }, [
                                React.createElement('div', { key: 'unsupported-info' }, [
                                    React.createElement('div', { key: 'label' }, 'Unsupported Territory'),
                                    React.createElement('div', { 
                                        key: 'contacts',
                                        className: 'text-xs text-red-600'
                                    }, `${unsupportedTerritory.contacts} contacts, ${unsupportedTerritory.deals} deals`)
                                ]),
                                React.createElement('span', { 
                                    key: 'burn-rate',
                                    className: 'font-bold text-red-600'
                                }, `${territories.burnRateSummary.burnRatePercentage}% burn`)
                            ])
                        ])
                    ])
                ]),

                // Footer
                React.createElement('div', {
                    className: 'text-center text-sm text-gray-500 mt-8',
                    key: 'footer'
                }, [
                    React.createElement('p', { key: 'footer-text' }, 
                        `Pipeline Analysis updated: ${new Date().toLocaleString()} | ` +
                        `Mode: ${analysisMode} | Range: ${dateRange} days`
                    ),
                    React.createElement('p', { key: 'footer-note', className: 'mt-2' }, 
                        'Enhanced with MQL→SQL validation tracking and territory burn rate analysis'
                    )
                ])
            ]);
        };

        // Render the component
        const container = document.getElementById('pipeline-root');
        const root = ReactDOM.createRoot(container);
        root.render(React.createElement(PipelineAnalysis));
    </script>
</body>
</html>