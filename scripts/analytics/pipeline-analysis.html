<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pipeline Analysis Dashboard</title>
    
    <!-- React & Dependencies -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Chart Library -->
    <script src="https://unpkg.com/recharts@2.8.0/umd/Recharts.js"></script>
    
    <!-- Icons -->
    <script src="https://unpkg.com/lucide-react@latest/dist/umd/lucide-react.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Custom Styles -->
    <style>
      body {
        margin: 0;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      }
      
      /* Loading animation */
      .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #3498db;
        border-radius: 50%;
        animation: spin 2s linear infinite;
      }
      
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      
      /* Smooth transitions */
      .card-hover {
        transition: all 0.3s ease;
      }
      
      .card-hover:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(0,0,0,0.1);
      }

      /* Pipeline stage hover effects */
      .pipeline-stage {
        transition: all 0.3s ease;
      }
      
      .pipeline-stage:hover {
        transform: translateY(-2px) scale(1.02);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
      }
    </style>
</head>
<body>
    <!-- React Mount Point -->
    <div id="root">
      <div class="min-h-screen bg-gray-100 flex items-center justify-center">
        <div class="text-center">
          <div class="loading"></div>
          <p class="mt-4 text-gray-600">Loading pipeline analysis...</p>
        </div>
      </div>
    </div>
    
    <!-- React Component -->
    <script type="text/babel">
        const { useState, useEffect } = React;
        
        const PipelineAnalysis = () => {
          const [dateRange, setDateRange] = useState('30');
          const [selectedCampaign, setSelectedCampaign] = useState('all');
          const [isLoading, setIsLoading] = useState(true);
          const [pipelineData, setPipelineData] = useState(null);
          const [campaigns, setCampaigns] = useState([]);
          const [error, setError] = useState(null);
          const [showProbabilityRefresh, setShowProbabilityRefresh] = useState(false);
          const [probabilityData, setProbabilityData] = useState(null);

          // Fetch pipeline data on component mount and when filters change
          useEffect(() => {
            fetchPipelineData();
          }, [dateRange, selectedCampaign]);

          // Main data fetch function - uses real MySQL API
          const fetchPipelineData = async () => {
            setIsLoading(true);
            setError(null);
            
            try {
              console.log(`‚ö° Fetching FAST pipeline data for ${dateRange} days, campaign: ${selectedCampaign}`);
              
              // Call the correct pipeline-data endpoint
              const response = await fetch(`/gads/analytics/pipeline-data?days=${dateRange}&campaign=${selectedCampaign}`);
              
              if (!response.ok) {
                throw new Error(`API error: ${response.status} ${response.statusText}`);
              }
              
              const result = await response.json();
              
              if (!result.success) {
                throw new Error(result.error || 'Failed to fetch pipeline data');
              }
              
              console.log('‚ö° FAST pipeline data loaded:', result);
              setPipelineData(result);
              setCampaigns(result.campaigns || []);

            } catch (err) {
              console.error('‚ùå Failed to fetch pipeline data:', err);
              setError(err.message);
            }
            
            setIsLoading(false);
          };

          // Probability refresh function (separate from main data)
          const fetchProbabilityData = async () => {
            try {
              console.log('üîÑ Refreshing probability data...');
              setShowProbabilityRefresh(true);
              
              // Call your existing pipeline-probs.js endpoint
              const response = await fetch(`/gads/analytics/prob?days=${dateRange}&pipeline=default`);
              const result = await response.json();
              
              if (result.success) {
                setProbabilityData(result);
                console.log('‚úÖ Probability data refreshed:', result);
              } else {
                throw new Error(result.error || 'Failed to fetch probability data');
              }
              
            } catch (err) {
              console.error('‚ùå Probability refresh failed:', err);
              setError(`Probability refresh failed: ${err.message}`);
            } finally {
              setShowProbabilityRefresh(false);
            }
          };

          const formatNumber = (num) => new Intl.NumberFormat().format(num || 0);
          const formatCurrency = (num) => new Intl.NumberFormat('en-EU', { 
            style: 'currency', currency: 'EUR', minimumFractionDigits: 0 
          }).format(num || 0);
          const formatPercentage = (num) => `${(num || 0).toFixed(1)}%`;

          // Loading state
          if (isLoading || !pipelineData) {
            return (
              <div className="min-h-screen bg-gradient-to-br from-slate-50 to-blue-50 flex items-center justify-center">
                <div className="text-center">
                  <div className="loading mb-4"></div>
                  <p className="text-lg text-gray-600">Loading pipeline analysis...</p>
                </div>
              </div>
            );
          }

          // Error state
          if (error) {
            return (
              <div className="min-h-screen bg-gradient-to-br from-slate-50 to-blue-50 flex items-center justify-center">
                <div className="text-center bg-white p-8 rounded-xl shadow-lg max-w-md">
                  <div className="text-red-500 text-4xl mb-4">‚ö†Ô∏è</div>
                  <h2 className="text-xl font-bold text-gray-900 mb-2">Pipeline Error</h2>
                  <p className="text-gray-600 mb-4">{error}</p>
                  <button 
                    className="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors"
                    onClick={fetchPipelineData}
                  >
                    Retry Loading
                  </button>
                </div>
              </div>
            );
          }

          const MQLStage = ({ title, data, color, isLast }) => (
            <div className="flex flex-col items-center">
              <div className={`${color} pipeline-stage rounded-lg p-4 min-w-[140px] text-center shadow-lg`}>
                <h4 className="font-semibold text-white text-sm mb-2">{title}</h4>
                <div className="text-2xl font-bold text-white mb-1">
                  {formatNumber(data.count)}
                </div>
                {data.ctr && (
                  <div className="text-xs text-blue-100">
                    CTR: {formatPercentage(data.ctr)}
                  </div>
                )}
                {data.conversionRate && (
                  <div className="text-xs text-blue-100">
                    CVR: {formatPercentage(data.conversionRate)}
                  </div>
                )}
                {data.rejectionRate && (
                  <div className="text-xs text-blue-100">
                    Rejected: {formatPercentage(data.rejectionRate)}
                  </div>
                )}
                {data.cost > 0 && (
                  <div className="text-xs text-blue-100 mt-1">
                    {formatCurrency(data.cost)}
                  </div>
                )}
                {data.source && (
                  <div className="text-xs text-blue-200 mt-1 opacity-75">
                    {data.source}
                  </div>
                )}
              </div>
              {!isLast && (
                <div className="flex items-center mt-4 mb-4">
                  <div className="w-8 h-0.5 bg-blue-300"></div>
                  <div className="w-2 h-2 bg-blue-400 rounded-full mx-1"></div>
                  <div className="w-8 h-0.5 bg-blue-300"></div>
                </div>
              )}
            </div>
          );

          const SQLStage = ({ title, data, color, probability, isLast }) => (
            <div className="flex flex-col items-center">
              <div className={`${color} pipeline-stage rounded-lg p-4 min-w-[120px] text-center shadow-lg`}>
                <h4 className="font-semibold text-white text-xs mb-2">{title}</h4>
                <div className="text-lg font-bold text-white mb-1">
                  {formatNumber(data.count)}
                </div>
                <div className="text-xs text-orange-100">
                  {formatPercentage(data.percentage)}
                </div>
                {probability && (
                  <div className="text-xs text-orange-100 mt-1 border-t border-orange-200 pt-1">
                    Win: {formatPercentage(probability.p_win * 100)}
                  </div>
                )}
              </div>
              {!isLast && (
                <div className="flex items-center mt-4 mb-4">
                  <div className="w-6 h-0.5 bg-orange-300"></div>
                  <div className="w-2 h-2 bg-orange-400 rounded-full mx-1"></div>
                  <div className="w-6 h-0.5 bg-orange-300"></div>
                </div>
              )}
            </div>
          );

          const { summary, mqlStages, sqlStages } = pipelineData;

          return (
            <div className="min-h-screen bg-gradient-to-br from-slate-50 to-blue-50 p-6">
              {/* Header */}
              <div className="mb-8">
                <div className="flex flex-col lg:flex-row lg:items-center lg:justify-between">
                  <div>
                    <h1 className="text-3xl font-bold text-gray-900 mb-2">
                      Pipeline Analysis
                    </h1>
                    <p className="text-gray-600">
                      Google Ads ‚Üí HubSpot Direct Sales Pipeline ({summary.period})
                    </p>
                  </div>
                  
                  {/* Controls */}
                  <div className="mt-4 lg:mt-0 flex flex-wrap gap-4">
                    {/* Campaign Filter */}
                    <div className="flex items-center space-x-2">
                      <span className="text-gray-500">üéØ</span>
                      <select
                        value={selectedCampaign}
                        onChange={(e) => setSelectedCampaign(e.target.value)}
                        className="bg-white border border-gray-300 rounded-lg px-3 py-2 text-gray-900 focus:ring-2 focus:ring-blue-500"
                      >
                        {campaigns.map(campaign => (
                          <option key={campaign.id} value={campaign.id}>
                            {campaign.name}
                          </option>
                        ))}
                      </select>
                    </div>
                    
                    {/* Date Range */}
                    <div className="flex items-center space-x-2">
                      <span className="text-gray-500">üìÖ</span>
                      <select
                        value={dateRange}
                        onChange={(e) => setDateRange(e.target.value)}
                        className="bg-white border border-gray-300 rounded-lg px-3 py-2 text-gray-900 focus:ring-2 focus:ring-blue-500"
                      >
                        <option value="7">Last 7 days</option>
                        <option value="30">Last 30 days</option>
                        <option value="90">Last 90 days</option>
                        <option value="365">Last year</option>
                      </select>
                    </div>
                    
                    {/* Probability Refresh */}
                    <button
                      onClick={fetchProbabilityData}
                      disabled={showProbabilityRefresh}
                      className="bg-purple-500 hover:bg-purple-600 disabled:bg-purple-300 text-white px-4 py-2 rounded-lg transition-colors flex items-center gap-2"
                    >
                      {showProbabilityRefresh ? 'üîÑ' : 'üìä'}
                      {showProbabilityRefresh ? 'Refreshing...' : 'Refresh Probabilities'}
                    </button>
                  </div>
                </div>
              </div>

              {/* Summary Cards */}
              <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                <div className="bg-white rounded-lg p-4 shadow-lg">
                  <div className="text-sm text-gray-600">Campaign</div>
                  <div className="text-xl font-bold text-gray-900">{summary.campaign}</div>
                </div>
                <div className="bg-white rounded-lg p-4 shadow-lg">
                  <div className="text-sm text-gray-600">Total Contacts</div>
                  <div className="text-xl font-bold text-gray-900">{formatNumber(summary.totalContacts)}</div>
                </div>
                <div className="bg-white rounded-lg p-4 shadow-lg">
                  <div className="text-sm text-gray-600">Total Ad Spend</div>
                  <div className="text-xl font-bold text-gray-900">{formatCurrency(summary.totalCost)}</div>
                </div>
                <div className="bg-white rounded-lg p-4 shadow-lg">
                  <div className="text-sm text-gray-600">Cost Per Contact</div>
                  <div className="text-xl font-bold text-gray-900">
                    {formatCurrency(summary.costPerContact)}
                  </div>
                </div>
              </div>

              {/* Pipeline Visualization */}
              <div className="bg-white rounded-xl shadow-lg p-8 mb-8">
                <h3 className="text-xl font-semibold text-gray-900 mb-6">
                  Horizontal Pipeline Flow
                </h3>
                
                {/* MQL Stages */}
                <div className="mb-8">
                  <h4 className="text-lg font-medium text-blue-600 mb-4 flex items-center gap-2">
                    <span>üéØ</span> MQL Stages (Google Ads)
                  </h4>
                  <div className="flex items-center justify-center overflow-x-auto">
                    <div className="flex items-center space-x-4 min-w-max">
                      <MQLStage
                        title="Impressions"
                        data={mqlStages.impressions}
                        color="bg-gradient-to-br from-blue-500 to-blue-600"
                      />
                      <MQLStage
                        title="Clicks"
                        data={mqlStages.clicks}
                        color="bg-gradient-to-br from-blue-600 to-blue-700"
                      />
                      <MQLStage
                        title="CTA Complete"
                        data={mqlStages.ctaComplete}
                        color="bg-gradient-to-br from-purple-500 to-purple-600"
                      />
                      <MQLStage
                        title="Territory Valid"
                        data={mqlStages.territoryValidation}
                        color="bg-gradient-to-br from-purple-600 to-purple-700"
                        isLast={true}
                      />
                    </div>
                  </div>
                </div>

                {/* Transition Arrow */}
                <div className="flex justify-center mb-8">
                  <div className="flex items-center">
                    <div className="w-16 h-1 bg-gradient-to-r from-purple-400 to-orange-400"></div>
                    <div className="w-4 h-4 bg-orange-400 rounded-full mx-2 flex items-center justify-center">
                      <span className="text-white text-xs">‚Üí</span>
                    </div>
                    <div className="w-16 h-1 bg-gradient-to-r from-orange-400 to-orange-500"></div>
                  </div>
                </div>

                {/* SQL Stages */}
                <div>
                  <h4 className="text-lg font-medium text-orange-600 mb-4 flex items-center gap-2">
                    <span>üè¢</span> SQL Stages (HubSpot)
                  </h4>
                  <div className="flex items-center justify-center overflow-x-auto">
                    <div className="flex items-center space-x-2 min-w-max">
                      <SQLStage
                        title="Inbox"
                        data={sqlStages.inbox}
                        color="bg-gradient-to-br from-orange-400 to-orange-500"
                        probability={probabilityData?.completion?.appointmentscheduled}
                      />
                      <SQLStage
                        title="Sequenced"
                        data={sqlStages.sequenced}
                        color="bg-gradient-to-br from-orange-500 to-orange-600"
                      />
                      <SQLStage
                        title="Engaging"
                        data={sqlStages.engaging}
                        color="bg-gradient-to-br from-orange-600 to-orange-700"
                        probability={probabilityData?.completion?.engaging}
                      />
                      <SQLStage
                        title="Responsive"
                        data={sqlStages.responsive}
                        color="bg-gradient-to-br from-red-500 to-red-600"
                        probability={probabilityData?.completion?.responsive}
                      />
                      <SQLStage
                        title="Advising"
                        data={sqlStages.advising}
                        color="bg-gradient-to-br from-red-600 to-red-700"
                        probability={probabilityData?.completion?.advising}
                      />
                      <SQLStage
                        title="Consideration"
                        data={sqlStages.consideration}
                        color="bg-gradient-to-br from-green-500 to-green-600"
                        probability={probabilityData?.completion?.consideration}
                      />
                      <SQLStage
                        title="Contract"
                        data={sqlStages.contract}
                        color="bg-gradient-to-br from-green-600 to-green-700"
                        probability={probabilityData?.completion?.contract}
                      />
                      <SQLStage
                        title="Won"
                        data={sqlStages.won}
                        color="bg-gradient-to-br from-emerald-600 to-emerald-700"
                        isLast={true}
                      />
                    </div>
                  </div>
                </div>
              </div>

              {/* Probability Analysis */}
              {probabilityData && (
                <div className="bg-white rounded-xl shadow-lg p-6 mb-8">
                  <h3 className="text-xl font-semibold text-gray-900 mb-4">
                    Stage Win Probabilities
                  </h3>
                  <div className="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-4">
                    {Object.entries(probabilityData.completion).map(([stage, data]) => (
                      <div key={stage} className="bg-gray-50 rounded-lg p-3 text-center">
                        <div className="text-sm font-medium text-gray-700 mb-1 capitalize">
                          {stage.replace(/([A-Z])/g, ' $1').trim()}
                        </div>
                        <div className="text-lg font-bold text-purple-600">
                          {formatPercentage(data.p_win * 100)}
                        </div>
                        <div className="text-xs text-gray-500">
                          {formatCurrency(data.euro_value)}
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {/* Data Source Info */}
              <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <div className="flex items-center space-x-2">
                  <span className="text-blue-500">‚ö°</span>
                  <div>
                    <p className="text-sm font-medium text-blue-900">
                      Data Source: MySQL Lightning Fast (26,440+ Google Ads Records)
                    </p>
                    <p className="text-xs text-blue-700">
                      {pipelineData?.dataSource} | Real-time MySQL queries | 
                      {summary?.dataQuality?.googleAdsRecords} metrics from 2014-2025
                    </p>
                  </div>
                </div>
              </div>
            </div>
          );
        };
        
        // Render the dashboard
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(PipelineAnalysis));
    </script>
    
    <!-- Error Handling -->
    <script>
      window.onerror = function(msg, url, line, col, error) {
        console.error('Pipeline Error:', msg, 'at', url, ':', line);
        document.getElementById('root').innerHTML = 
          '<div class="min-h-screen bg-red-50 flex items-center justify-center">' +
          '<div class="text-center p-8">' +
          '<h1 class="text-2xl font-bold text-red-600 mb-4">Pipeline Error</h1>' +
          '<p class="text-red-500 mb-2">' + msg + '</p>' +
          '<p class="text-gray-500 text-sm">Check console for details</p>' +
          '</div></div>';
        return true;
      };
    </script>
</body>
</html>