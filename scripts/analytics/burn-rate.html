<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üî• Burn Rate Analysis - Google Ads Waste Detection</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 2.5rem;
            color: #2c3e50;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header p {
            color: #7f8c8d;
            font-size: 1.1rem;
            line-height: 1.6;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #7f8c8d;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .burn-rate {
            color: #e74c3c;
        }

        .waste-contacts {
            color: #e67e22;
        }

        .total-contacts {
            color: #3498db;
        }

        .territories-count {
            color: #9b59b6;
        }

        .main-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #ecf0f1;
        }

        .section-title {
            font-size: 1.5rem;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .filters {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .filter-select {
            padding: 10px 15px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s ease;
        }

        .filter-select:focus {
            border-color: #3498db;
        }

        .refresh-btn {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s ease;
        }

        .refresh-btn:hover {
            transform: scale(1.05);
        }

        .campaign-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .campaign-table th {
            background: linear-gradient(45deg, #34495e, #2c3e50);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 1px;
        }

        .campaign-table td {
            padding: 15px;
            border-bottom: 1px solid #ecf0f1;
            vertical-align: top;
        }

        .campaign-table tr:hover {
            background-color: #f8f9fa;
        }

        .campaign-id {
            font-family: 'Monaco', 'Menlo', monospace;
            background: #ecf0f1;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9rem;
        }

        .unsupported-contacts {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            text-align: center;
            min-width: 60px;
            display: inline-block;
        }

        .spend-amount {
            font-weight: bold;
            color: #e74c3c;
            font-size: 1.1rem;
        }

        .targeting-info {
            font-size: 0.9rem;
            color: #7f8c8d;
        }

        .exclusions {
            background: #2ecc71;
            color: white;
            padding: 3px 8px;
            border-radius: 15px;
            font-size: 0.8rem;
            margin: 2px;
            display: inline-block;
        }

        .no-exclusions {
            background: #e74c3c;
            color: white;
            padding: 3px 8px;
            border-radius: 15px;
            font-size: 0.8rem;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #7f8c8d;
        }

        .error {
            background: #e74c3c;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .territories-list {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
        }

        .territory-tag {
            background: #e74c3c;
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }
.chart-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin: 25px 0;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            max-width: 500px;
            height: 500px;
            margin: 25px auto;
        }

        .back-btn {
            background: linear-gradient(45deg, #95a5a6, #7f8c8d);
            color: white;
            text-decoration: none;
            padding: 12px 25px;
            border-radius: 10px;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            transition: transform 0.2s ease;
            margin-bottom: 20px;
        }

        .back-btn:hover {
            transform: scale(1.05);
            text-decoration: none;
            color: white;
        }

        .debug-info {
            background: #f39c12;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            font-family: monospace;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="/gads/" class="back-btn">
            ‚Üê Back to Dashboard
        </a>

        <div class="header">
            <h1>
                üî• Burn Rate Analysis
            </h1>
            <p>
                Identify Google Ads campaigns wasting budget on unsupported territories. 
                This analysis shows exactly which campaigns are attracting traffic from countries 
                where you cannot provide services, allowing you to optimize targeting and reduce waste.
            </p>
        </div>

        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <div class="stat-value burn-rate" id="burnRateValue">--</div>
                <div class="stat-label">Burn Rate</div>
            </div>
            <div class="stat-card">
                <div class="stat-value waste-contacts" id="wasteContactsValue">--</div>
                <div class="stat-label">Wasted Contacts</div>
            </div>
            <div class="stat-card">
                <div class="stat-value total-contacts" id="totalContactsValue">--</div>
                <div class="stat-label">Total Contacts</div>
            </div>
            <div class="stat-card">
                <div class="stat-value territories-count" id="territoriesCountValue">--</div>
                <div class="stat-label">Unsupported Countries</div>
            </div>
        </div>

        <div class="chart-container">
            <canvas id="burnRateChart" width="400" height="200"></canvas>
        </div>

        <div class="main-content">
            <div class="section-header">
                <h2 class="section-title">
                    üìä Campaign Burn Rate Analysis
                </h2>
                <div class="filters">
                    <select class="filter-select" id="timeRange">
                        <option value="7">Last 7 days</option>
                        <option value="30" selected>Last 30 days</option>
                        <option value="90">Last 90 days</option>
                    </select>
                    <button class="refresh-btn" onclick="loadBurnRateData()">
                        üîÑ Refresh
                    </button>
                </div>
            </div>

            <div id="loadingSpinner" class="loading">
                <div>üîÑ Loading burn rate analysis...</div>
            </div>

            <div id="errorContainer"></div>
            <div id="debugInfo"></div>

            <table class="campaign-table" id="campaignTable" style="display: none;">
                <thead>
                    <tr>
                        <th>Campaign Name</th>
                        <th>Keywords</th>
                        <th>Total Contacts</th>
                        <th>Revenue</th>
                        <th>Conversion Rate</th>
                        <th>Unsupported Contacts</th>
                        <th>Estimated Waste</th>
                    </tr>
                </thead>
                <tbody id="campaignTableBody">
                </tbody>
            </table>

            <div id="unsupportedTerritories" style="margin-top: 30px;">
                <h3 class="section-title">üö´ Unsupported Territories Detected</h3>
                <div id="territoriesListContainer">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <script>
        let burnRateChart;

        async function loadBurnRateData() {
            const timeRange = document.getElementById('timeRange').value;
            const loadingSpinner = document.getElementById('loadingSpinner');
            const errorContainer = document.getElementById('errorContainer');
            const debugInfo = document.getElementById('debugInfo');
            const campaignTable = document.getElementById('campaignTable');
            
            // Show loading
            loadingSpinner.style.display = 'block';
            campaignTable.style.display = 'none';
            errorContainer.innerHTML = '';
            debugInfo.innerHTML = '';

            try {
                // Load territory analysis data first
                console.log(`Loading territory data for ${timeRange} days...`);
                const territoryResponse = await fetch(`/gads/api/territories?days=${timeRange}`);
                
                if (!territoryResponse.ok) {
                    throw new Error(`Territory API error: ${territoryResponse.status} ${territoryResponse.statusText}`);
                }
                
                const territoryData = await territoryResponse.json();

                if (!territoryData.success) {
                    throw new Error(territoryData.error || 'Failed to load territory data');
                }

                console.log('Territory data loaded:', territoryData);

                // Update stats
                updateStats(territoryData);
                
                // Update chart
                updateBurnRateChart(territoryData);
                
                // Load campaign analysis 
                await loadCampaignAnalysis(territoryData, timeRange);
                
                // Show unsupported territories
                displayUnsupportedTerritories(territoryData);

                loadingSpinner.style.display = 'none';
                campaignTable.style.display = 'table';

            } catch (error) {
                console.error('Error loading burn rate data:', error);
                loadingSpinner.style.display = 'none';
                
                debugInfo.innerHTML = `
                    <div class="debug-info">
                        üîç <strong>Debug Information:</strong><br>
                        Error: ${error.message}<br>
                        Time: ${new Date().toISOString()}<br>
                        Endpoint tried: /gads/api/territories?days=${timeRange}<br>
                        <br>
                        <strong>Available endpoints to test:</strong><br>
                        ‚Ä¢ <a href="/gads/api/territories?days=30" target="_blank" style="color: #fff;">/gads/api/territories?days=30</a><br>
                        ‚Ä¢ <a href="/gads/api/campaigns?days=30" target="_blank" style="color: #fff;">/gads/api/campaigns?days=30</a><br>
                        ‚Ä¢ <a href="/gads/analytics/territory?days=30" target="_blank" style="color: #fff;">/gads/analytics/territory?days=30</a><br>
                    </div>
                `;
                
                errorContainer.innerHTML = `
                    <div class="error">
                        ‚ùå Error loading burn rate data: ${error.message}
                        <br><br>
                        Check the debug information below for more details.
                    </div>
                `;
            }
        }

        function updateStats(data) {
            const burnRate = data.burnRateSummary?.burnRatePercentage || '0';
            const wasteContacts = data.burnRateSummary?.unsupportedContacts || 0;
            const totalContacts = data.burnRateSummary?.totalContacts || 0;
            const territoriesCount = data.burnRateSummary?.unsupportedTerritoriesCount || 0;

            document.getElementById('burnRateValue').textContent = burnRate + '%';
            document.getElementById('wasteContactsValue').textContent = wasteContacts;
            document.getElementById('totalContactsValue').textContent = totalContacts;
            document.getElementById('territoriesCountValue').textContent = territoriesCount;
        }

        function updateBurnRateChart(data) {
            const ctx = document.getElementById('burnRateChart').getContext('2d');
            
            if (burnRateChart) {
                burnRateChart.destroy();
            }

            const totalContacts = data.burnRateSummary?.totalContacts || 0;
            const unsupportedContacts = data.burnRateSummary?.unsupportedContacts || 0;
            const supportedContacts = totalContacts - unsupportedContacts;
            
            burnRateChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Supported Territories', 'Unsupported (Waste)'],
                    datasets: [{
                        data: [supportedContacts, unsupportedContacts],
                        backgroundColor: ['#2ecc71', '#e74c3c'],
                        borderWidth: 3,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: `Contact Distribution: ${totalContacts} Total Contacts`,
                            font: { size: 16, weight: 'bold' }
                        },
                        legend: {
                            position: 'bottom',
                            labels: { padding: 20, font: { size: 14 } }
                        }
                    }
                }
            });
        }

        async function loadCampaignAnalysis(territoryData, timeRange) {
            try {
                console.log(`Loading campaign data for ${timeRange} days...`);
                
                // Use the correct API endpoint from your index.js routes
                const campaignResponse = await fetch(`/gads/api/campaigns?days=${timeRange}`);
                
                if (!campaignResponse.ok) {
                    throw new Error(`Campaign API error: ${campaignResponse.status} ${campaignResponse.statusText}`);
                }
                
                const campaignData = await campaignResponse.json();
                console.log('Campaign data loaded:', campaignData);

                if (!campaignData.success) {
                    throw new Error(campaignData.error || 'Failed to load campaign data');
                }

                const campaigns = campaignData.campaigns || [];
                const tableBody = document.getElementById('campaignTableBody');
                tableBody.innerHTML = '';

                if (campaigns.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td colspan="7" style="text-align: center; padding: 30px; color: #7f8c8d;">
                            No campaign data available for this period<br>
                            <small>Make sure HubSpot sync has run and there are contacts with PAID_SEARCH source</small>
                        </td>
                    `;
                    tableBody.appendChild(row);
                    return;
                }

                // Calculate overall burn rate from territory data
                const burnRatePercentage = territoryData.burnRateSummary?.burnRatePercentage || 0;
                const burnRateDecimal = parseFloat(burnRatePercentage) / 100;

                campaigns.forEach(campaign => {
                    // Calculate unsupported contacts for this campaign based on actual burn rate
                    const totalContacts = campaign.contacts || 0;
                    const unsupportedContacts = Math.round(totalContacts * burnRateDecimal);
                    const estimatedWastePerContact = 25; // Estimated cost per contact
                    const estimatedWaste = (unsupportedContacts * estimatedWastePerContact).toFixed(0);
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>
                            <div style="font-weight: bold;">${campaign.name || 'Unknown Campaign'}</div>
                            <div class="targeting-info">From HubSpot: hs_analytics_source_data_1</div>
                        </td>
                        <td>
                            <div>${campaign.keywords || 'Not specified'}</div>
                            <div class="targeting-info">From HubSpot: hs_analytics_source_data_2</div>
                        </td>
                        <td>
                            <div style="font-weight: bold; color: #3498db;">${totalContacts}</div>
                            <div class="targeting-info">Total contacts</div>
                        </td>
                        <td>
                            <div style="font-weight: bold; color: #27ae60;">$${campaign.revenue ? parseFloat(campaign.revenue).toFixed(2) : '0.00'}</div>
                            <div class="targeting-info">${campaign.deals || 0} deals</div>
                        </td>
                        <td>
                            <div style="font-weight: bold;">${campaign.conversionRate || '0'}%</div>
                            <div class="targeting-info">Contacts to deals</div>
                        </td>
                        <td>
                            <div class="unsupported-contacts">${unsupportedContacts}</div>
                            <div class="targeting-info">${burnRatePercentage}% of ${totalContacts}</div>
                        </td>
                        <td>
                            <div class="spend-amount">$${estimatedWaste}</div>
                            <div class="targeting-info">Est: ${unsupportedContacts} √ó $${estimatedWastePerContact}</div>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });

            } catch (error) {
                console.error('Error loading campaign data:', error);
                
                const tableBody = document.getElementById('campaignTableBody');
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="7" style="text-align: center; padding: 30px; color: #e74c3c;">
                        ‚ùå Error loading campaign data: ${error.message}
                        <br><br>
                        <small>Endpoint tried: /gads/api/campaigns?days=${timeRange}</small>
                    </td>
                `;
                tableBody.appendChild(row);
            }
        }

        function displayUnsupportedTerritories(data) {
            const container = document.getElementById('territoriesListContainer');
            const unsupportedTerritory = data.territories?.find(t => t.isUnsupported);
            
            if (unsupportedTerritory && unsupportedTerritory.rawTerritories && unsupportedTerritory.rawTerritories.length > 0) {
                const territoriesHtml = unsupportedTerritory.rawTerritories.map(territory => 
                    `<span class="territory-tag">${territory}</span>`
                ).join('');
                
                container.innerHTML = `
                    <div class="territories-list">
                        ${territoriesHtml}
                    </div>
                    <p style="margin-top: 15px; color: #7f8c8d;">
                        These ${unsupportedTerritory.rawTerritories.length} countries generated 
                        <strong>${unsupportedTerritory.contacts} contacts</strong> with 
                        <strong>${unsupportedTerritory.deals} deals</strong> - indicating ${unsupportedTerritory.deals === 0 ? 'complete waste' : 'poor performance'} of ad spend.
                    </p>
                `;
            } else {
                container.innerHTML = `
                    <p style="color: #7f8c8d;">
                        No unsupported territory data found in the current dataset.
                        <br>
                        <small>This might indicate that the country classification system needs to be updated.</small>
                    </p>
                `;
            }
        }

        // Load data on page load
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Burn Rate Analysis page loaded');
            loadBurnRateData();
        });
        
        // Auto-refresh every 5 minutes
        setInterval(loadBurnRateData, 5 * 60 * 1000);
    </script>
</body>
</html>